<!-- SIDEBAR - barra lateral minimalista, solo con boton de toggle-->
<div
    class="sidebar-base"
    [class.sidebar-expanded]="!isSidebarCollapsed"
    [class.sidebar-collapsed]="isSidebarCollapsed"
>
    <div class="sidebar-menu">
        <div class="sidebar-title" *ngIf="!isSidebarCollapsed">Mis interacciones</div>
        <div class="sidebar-item" (click)="onAgregarPregunta()">
            <i class="material-icons sidebar-icon" [class.sidebar-icon-expanded]="!isSidebarCollapsed" [class.sidebar-icon-collapsed]="isSidebarCollapsed">add</i>
            <span class="sidebar-text" [class.sidebar-text-visible]="!isSidebarCollapsed" [class.sidebar-text-hidden]="isSidebarCollapsed">Agregar pregunta</span>
        </div>
        <div class="sidebar-title" *ngIf="!isSidebarCollapsed">Cuestionarios guardados</div>
        <!-- Cuestionarios guardados -->
        <div class="sidebar-item questionnaire-item" *ngFor="let savedQuiz of savedQuestionnaires" (click)="selectSavedQuestionnaire(savedQuiz)">
            <i class="material-icons sidebar-icon" [class.sidebar-icon-expanded]="!isSidebarCollapsed" [class.sidebar-icon-collapsed]="isSidebarCollapsed">assignment</i>
            <div class="questionnaire-info" *ngIf="!isSidebarCollapsed">
                <span class="questionnaire-name">{{ savedQuiz.title }}</span>
                <span class="questionnaire-count">{{ savedQuiz.questions_data?.length || 0 }} preguntas</span>
            </div>
        </div>

        <div class="sidebar-title" *ngIf="!isSidebarCollapsed">Preguntas del quizzy</div>
        <!-- elemneto del cuestionario actual (solo si está guardado) -->
        <div class="sidebar-item questionnaire-item" *ngIf="isQuestionnaireSaved" (click)="seleccionarTipo('cuestionario')">
            <i class="material-icons sidebar-icon" [class.sidebar-icon-expanded]="!isSidebarCollapsed" [class.sidebar-icon-collapsed]="isSidebarCollapsed">assignment</i>
            <div class="questionnaire-info" *ngIf="!isSidebarCollapsed">
                <span class="questionnaire-name">{{ questionnaireTitle || 'Cuestionario sin título' }}</span>
                <span class="questionnaire-count">{{ questions.length }} preguntas</span>
            </div>
        </div>

        <div class="sidebar-item" *ngFor="let question of questions" (click)="loadQuestionForEditing(question)">
            <i class="material-icons sidebar-icon" [class.sidebar-icon-expanded]="!isSidebarCollapsed" [class.sidebar-icon-collapsed]="isSidebarCollapsed">
                {{ question.question_type === 'multiple' ? 'checklist' : question.question_type === 'abierta' ? 'chat_bubble_outline' : 'assignment' }}
            </i>
            <span class="sidebar-text" [class.sidebar-text-visible]="!isSidebarCollapsed" [class.sidebar-text-hidden]="isSidebarCollapsed">
                {{ question.text | slice:0:30 }}{{ question.text.length > 30 ? '...' : '' }}
            </span>
            <div class="sidebar-menu-container" *ngIf="!isSidebarCollapsed">
                <i class="material-icons sidebar-menu-icon" (click)="toggleMenu($event, question)">more_vert</i>
                <div class="sidebar-dropdown" [class.show]="question.showMenu">
                    <div class="sidebar-dropdown-item" (click)="duplicateQuestion(question)">
                        <i class="material-icons">content_copy</i>
                        <span>Duplicar</span>
                    </div>
                    <div class="sidebar-dropdown-item delete-item" (click)="deleteQuestionFromQuestionnaire(question)">
                        <i class="material-icons">delete_outline</i>
                        <span>Eliminar</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- BOTON DE COLAPSAR/EXPANDIR con animacion de rotacion-->
 <div
    (click)="toggleSidebar()"
    class="chevron-button"
    [class.chevron-expanded]="!isSidebarCollapsed"
    [class.chevron-collapsed]="isSidebarCollapsed"
>
<!-- icono de chevrones -->
  <svg style="width: 100%; height: 100%;" fill="none" preserveAspectRatio="none" viewBox="0 0 24 24">
    <path d="M15 18L9 12L15 6" stroke="#F3F3F3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</div>

<!-- contenido principal -->
<div
    class="transition-all duration-400"
    [class.content-expanded]="!isSidebarCollapsed"
    [class.content-collapsed]="isSidebarCollapsed"
>

    <div class="crear-container">
        <!-- Vista del cuestionario -->
        <div *ngIf="currentView === 'cuestionario'" class="multiple-choice-form">
            <div class="config-container">
                <div class="header">
                    <div class="title-group">
                        <i class="material-icons">assignment</i>
                        <span>Cuestionario</span>
                    </div>
                    <div class="header-actions">
                        <button class="save-btn" (click)="saveCompleteQuestionnaire()">
                            Guardar Cuestionario
                        </button>
                        <div class="delete-icon">
                            <i class="material-icons">delete_outline</i>
                        </div>
                    </div>
                </div>

                <div class="content">
                    <input
                        type="text"
                        class="question-input"
                        placeholder="Nombre del cuestionario..."
                        [(ngModel)]="questionnaireTitle">

                    <!-- Estado vacío -->
                    <div class="empty-state" *ngIf="showEmptyState" id="emptyState">
                        <p class="text-muted mb-4">El cuestionario está vacío</p>
                        <button class="btn-add-first">
                            <i class="material-icons">add</i>
                            <span>Añadir primera pregunta</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista de opciones de preguntas -->
        <div *ngIf="currentView === 'options'" class="interaction-grid" [class.animate-cards]="animateCards">

            <!-- Opción múltiple -->
            <div class="interaction-card" (click)="seleccionarTipo('multiple')">
            <div class="card-icon blue">
                <i class="material-icons">checklist</i>
            </div>
            <h3>Opción múltiple</h3>
            </div>

            <!-- Abrir texto -->
            <div class="interaction-card" (click)="seleccionarTipo('abierta')">
            <div class="card-icon teal">
                <i class="material-icons">chat_bubble_outline</i>
            </div>
            <h3>Abrir texto</h3>
            </div>

            <!-- Cuestionario -->
            <div class="interaction-card" (click)="seleccionarTipo('cuestionario')">
            <div class="card-icon orange">
                <i class="material-icons">assignment</i>
            </div>
            <h3>Cuestionario</h3>
            </div>

        </div>

        <!-- Vista del formulario de pregunta múltiple -->
        <div *ngIf="currentView === 'form'" class="multiple-choice-form">
            <div class="config-container">
                <div class="header">
                    <div class="title-group">
                        <div class="dropdown-container">
                            <div class="dropdown-trigger-area" (click)="toggleDropdown()">
                                <i class="material-icons">{{ currentQuestionTypeConfig.icon}}</i>
                                <span>{{ currentQuestionTypeConfig.name }}</span>
                                <i class="material-icons">keyboard_arrow_down</i>
                            </div>
                            <div class="dropdown-menu" [class.show]="showDropdown">
                                
                                <div class="dropdown-option" (click)="selectQuestionType('multiple')">Opción múltiple</div>
                                <div class="dropdown-option" (click)="selectQuestionType('abierta')">Pregunta abierta</div>

                            </div>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button class="save-btn" (click)="saveQuestionnaire()">
                            {{ isEditing ? 'Actualizar Pregunta' : 'Guardar Pregunta' }}
                        </button>
                        <div class="delete-icon" (click)="deleteQuestion()">
                            <i class="material-icons">delete_outline</i>
                        </div>
                        <div class="config-icon" (click)="toggleConfigSidebar(); $event.stopPropagation()">
                            <i class="material-icons">settings</i>
                            <span>Configuración de pregunta</span>
                        </div>
                    </div>
                </div>

                <div class="content">
                    <input
                        type="text"
                        class="question-input"
                        placeholder="¿Qué desea preguntar?"
                        [(ngModel)]="questionText"
                        autofocus>

                    <!-- campo de descripcion de la pregunta -->
                     <div *ngIf="showQuestionDescription" class="question-description-container">
                        <textarea
                            class="question-description-input"
                            placeholder="Escribe una descripción adicional para la pregunta..."
                            [(ngModel)]="questionDescription"
                            rows="3"></textarea>
                     </div>
                    <!-- mensaje cuando selecciona la respuesta correcta (solo para preguntas múltiples) -->
                     <div *ngIf="selectedQuestionType === 'multiple' && showCorrectAnswer && !hasCorrectAnswers" class="correct-answer-info">
                        <i class="material-icons">info</i>
                        <p>No olvide marcar la respuesta correcta</p>
                     </div>

                    <!-- Formulario para opción múltiple -->
                    <div *ngIf="selectedQuestionType === 'multiple'">
                        <div class="options-list">
                            <div class="option-row" *ngFor="let option of options; let i = index; trackBy: trackByIndex">
                                <input
                                    type="text"
                                    class="option-input"
                                    [placeholder]="'Opción ' + (i + 1)"
                                    [(ngModel)]="option.text">
                                    
                                <!-- icono de respuesta correcta -->
                                 <span
                                    *ngIf="showCorrectAnswer"
                                    class="material-icons correct-answer-icon"
                                    [class.correct-selected]="option.isCorrect"
                                    (click)="toggleCorrectOption(i)">
                                    check_circle_outline
                                 </span>
                                 
                                <span class="material-icons delete-option" (click)="removeOption(i)">close</span>
                            </div>
                        </div>

                        <div class="add-option" (click)="addOption()">
                            <i class="material-icons">add</i>
                            <span>Añadir opción</span>
                        </div>
                    </div>

                    <!-- Formulario para pregunta abierta -->
                    <div *ngIf="selectedQuestionType === 'abierta'" class="open-question-form">
                        <textarea
                            class="open-question-textarea"
                            placeholder="El estudiante podrá escribir su respuesta aquí..."
                            readonly></textarea>
                    </div>


                </div>
            </div>
        </div>
    </div>

    <!-- sidebar derecho de configuracio -->
    <div class="config-sidebar" [class.open]="showConfigSidebar">
        <div class="config-sidebar-header">
            <div class="config-sidebar-title">
                <span>Configuración de pregunta</span>
            </div>
            <div class="config-sidebar-close" (click)="toggleConfigSidebar()">
                <span>Cerrar</span>
                <i class="material-icons">cancel</i>
            </div>
        </div>
        <div class="config-sidebar-content">
            <div class="config-option">
                <!-- Opciones para preguntas múltiples -->
                <div *ngIf="selectedQuestionType === 'multiple'">
                    <button class="toggle-button" (click)="toggleMultipleOptions()">
                        <span class="toggle-text">Varias opciones</span>
                        <i class="material-icons toggle-icon" [ngClass]="{'toggle-on': allowMultipleOptions, 'toggle-off': !allowMultipleOptions}">
                            {{ allowMultipleOptions ? 'toggle_on' : 'toggle_off' }}
                        </i>
                    </button>
                    <p class="option-description">
                        Los participantes pueden seleccionar más de una opción
                    </p>
                    <!-- Sección adicional cuando varias opciones está activado -->
                    <div *ngIf="allowMultipleOptions" class="max-options-config">
                        <div class="max-options-row">
                            <span class="max-options-text">
                                Los participantes pueden seleccionar hasta:
                            </span>
                            <div class="max-options-controls">
                                <button class="control-btn" (click)="decreaseMaxOptions()">
                                    <i class="material-icons">do_not_disturb_on</i>
                                </button>
                                <span class="max-options-number">{{ maxSelectableOptions }}</span>
                                <button class="control-btn" (click)="increaseMaxOptions()">
                                    <i class="material-icons">add_circle</i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <button class="toggle-button" (click)="toggleCorrectAnswer()">
                        <span class="toggle-text">Marque la respuesta correcta</span>
                        <i class="material-icons toggle-icon" [ngClass]="{'toggle-on': showCorrectAnswer, 'toggle-off': !showCorrectAnswer}">
                            {{ showCorrectAnswer ? 'toggle_on' : 'toggle_off' }}
                        </i>
                    </button>
                    <p class="option-description">
                        Seleccione y muestre la respuesta correcta para los participantes
                    </p>
                </div>

                <!-- Opción común para todas las preguntas: Descripción -->
                <button class="toggle-button" (click)="toggleQuestionDescription()">
                    <span class="toggle-text"> Descripción  de la pregunta</span>
                    <i class="material-icons toggle-icon" [ngClass]="{'toggle-on': showQuestionDescription, 'toggle-off': !showQuestionDescription}">
                        {{ showQuestionDescription ? 'toggle_on' : 'toggle_off'}}
                    </i>
                </button>
                <p class="option-description">
                    Agregar una descripción visible para los participantes
                </p>
            </div>
        </div>
    </div>
    <!-- overlay para cerrar el sidebar haciendo click afuera -->
     <div class="config-sidebar-overlay"
     [class.active]="showConfigSidebar"
     (click)="toggleConfigSidebar()"></div>
